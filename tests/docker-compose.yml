services:
  kafka:
    container_name: file-writer-kafka
    hostname: file-writer-kafka
    image: confluentinc/cp-kafka:7.4.3
    deploy:
      resources:
        limits:
          memory: 600M
    restart: always
    depends_on:
      - zookeeper
    ports:
      - "9093:9093"
    networks:
      - scicat-network
    environment:
      KAFKA_ZOOKEEPER_CONNECT: file-writer-zookeeper:2181
      KAFKA_BROKER_ID: 0
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_MESSAGE_MAX_BYTES: 300000000
      KAFKA_SOCKET_REQUEST_MAX_BYTES: 300000000
      KAFKA_REPLICA_FETCH_MAX_BYTES: 300000000
      KAFKA_LOG_RETENTION_MS: -1 # keep data forever, required for tests involving fake "historical" data
      ## listeners
      KAFKA_LISTENERS: INSIDE://:9092,OUTSIDE://:9093
      KAFKA_ADVERTISED_LISTENERS: INSIDE://file-writer-kafka:9092,OUTSIDE://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INSIDE:PLAINTEXT,OUTSIDE:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INSIDE
    healthcheck:
      test: [ "CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list" ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  zookeeper:
    container_name: file-writer-zookeeper
    hostname: file-writer-zookeeper
    image: confluentinc/cp-zookeeper:7.4.3
    deploy:
      resources:
        limits:
          memory: 200M
    restart: always
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - scicat-network

  #filewriter:
  #  container_name: file-writer-file-writer
  #  image: registry.esss.lu.se/ecdc/ess-dmsc/docker-centos7-build-node:latest
  #  depends_on:
  #    kafka:
  #      condition: service_healthy
  #  tty: true
  #  networks:
  #    - frontend

  # =============================================================================
  # MongoDB - Database for SciCat Backend
  # =============================================================================
  mongodb:
    container_name: scicat-mongodb
    hostname: scicat-mongodb
    image: mongo:6.0.14
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin
      MONGO_INITDB_DATABASE: scicat
    networks:
      - scicat-network
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # =============================================================================
  # SciCat Backend - Data Catalog API
  # =============================================================================
  scicat-backend:
    container_name: scicat-backend
    hostname: scicat-backend
    image: ghcr.io/scicatproject/backend-next:stable
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
    ports:
      - "3000:3000"
    networks:
      - scicat-network
    environment:
      # MongoDB Configuration
      MONGODB_URI: mongodb://admin:admin@scicat-mongodb:27017/scicat?authSource=admin
      # JWT Configuration
      JWT_SECRET: a_scicat_secret
      JWT_EXPIRES_IN: 36000
      # Admin Configuration
      ADMIN_GROUPS: admin,ingestor
      CREATE_DATASET_GROUPS: admin,ingestor
      CREATE_DATASET_WITH_PID_GROUPS: admin,ingestor
      # Logging
      LOG_LEVEL: debug
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/explorer" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    volumes:
      # Mount functional accounts configuration
      - ./integration/functionalAccounts.json:/home/node/app/functionalAccounts.json:ro

networks:
  scicat-network:
    driver: bridge
